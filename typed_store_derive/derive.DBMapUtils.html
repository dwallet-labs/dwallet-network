<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="A helper macro to simplify common operations for opening and debugging TypedStore (currently internally structs of DBMaps) It operates on a struct where all the members are of Store&lt;K, V&gt; or DBMap&lt;K, V&gt; `TypedStoreDebug` traits are then derived The main features are:"><title>DBMapUtils in typed_store_derive - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-2fcac8296ac587d8.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="typed_store_derive" data-themes="" data-resource-suffix="" data-rustdoc-version="1.72.0-nightly (8c74a5d27 2023-06-14)" data-search-js="search-c61faa3a19cfda94.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../static.files/storage-62ce34ea385b278a.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-762bcae8c0777c4b.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc derive"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../typed_store_derive/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../typed_store_derive/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><div class="sidebar-elems"><h2><a href="index.html">In typed_store_derive</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Derive Macro <a href="index.html">typed_store_derive</a>::<wbr><a class="derive" href="#">DBMapUtils</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/typed_store_derive/lib.rs.html#284-648">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>#[derive(DBMapUtils)]
{
    // Attributes available to this derive:
    #[default_options_override_fn]
}
</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>A helper macro to simplify common operations for opening and debugging TypedStore (currently internally structs of DBMaps)
It operates on a struct where all the members are of Store&lt;K, V&gt; or DBMap&lt;K, V&gt;
<code>TypedStoreDebug</code> traits are then derived
The main features are:</p>
<ol>
<li>
<p>Flexible configuration of each table (column family) via defaults and overrides</p>
</li>
<li>
<p>Auto-generated <code>open</code> routine</p>
</li>
<li>
<p>Auto-generated <code>read_only_mode</code> handle</p>
</li>
<li>
<p>Auto-generated memory stats method</p>
</li>
<li>
<p>Other convenience features</p>
</li>
<li>
<p>Flexible configuration:
a. Static options specified at struct definition
The definer of the struct can specify the default options for each table using annotations
We can also supply column family options on the default ones
A user defined function of signature () -&gt; Options can be provided for each table
If a an override function is not specified, the default in <code>typed_store::rocks::default_db_options</code> is used</p>
</li>
</ol>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>typed_store::rocks::DBOptions;
<span class="kw">use </span>typed_store::rocks::DBMap;
<span class="kw">use </span>typed_store::rocks::MetricConf;
<span class="kw">use </span>typed_store_derive::DBMapUtils;
<span class="kw">use </span>typed_store::traits::TypedStoreDebug;
<span class="kw">use </span>typed_store::traits::TableSummary;
<span class="kw">use </span>core::fmt::Error;
<span class="doccomment">/// Define a struct with all members having type DBMap&lt;K, V&gt;

</span><span class="kw">fn </span>custom_fn_name1() -&gt; DBOptions {DBOptions::default()}
<span class="kw">fn </span>custom_fn_name2() -&gt; DBOptions {
    <span class="kw">let </span><span class="kw-2">mut </span>op = custom_fn_name1();
    op.options.set_write_buffer_size(<span class="number">123456</span>);
    op
}
<span class="attr">#[derive(DBMapUtils)]
</span><span class="kw">struct </span>Tables {
    <span class="doccomment">/// Specify custom options function `custom_fn_name1`
    </span><span class="attr">#[default_options_override_fn = <span class="string">&quot;custom_fn_name1&quot;</span>]
    </span>table1: DBMap&lt;String, String&gt;,
    <span class="attr">#[default_options_override_fn = <span class="string">&quot;custom_fn_name2&quot;</span>]
    </span>table2: DBMap&lt;i32, String&gt;,
    <span class="comment">// Nothing specified so `typed_store::rocks::default_db_options` is used
    </span>table3: DBMap&lt;i32, String&gt;,
    <span class="attr">#[default_options_override_fn = <span class="string">&quot;custom_fn_name1&quot;</span>]
    </span>table4: DBMap&lt;i32, String&gt;,
}

<span class="comment">// b. Options specified by DB opener
// For finer control, we also allow the opener of the DB to specify their own options which override the defaults set by the definer
// This is done via a configurator which gives one a struct with field similarly named as that of the DB, but of type Options

</span><span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
<span class="comment">// Get a configurator for this table
</span><span class="kw">let </span><span class="kw-2">mut </span>config = Tables::configurator();
<span class="comment">// Config table 1
</span>config.table1 = DBOptions::default();
config.table1.options.create_if_missing(<span class="bool-val">true</span>);
config.table1.options.set_write_buffer_size(<span class="number">123456</span>);

<span class="kw">let </span>primary_path = tempfile::tempdir().expect(<span class="string">&quot;Failed to open temporary directory&quot;</span>).into_path();

<span class="comment">// We can then open the DB with the configs
</span><span class="kw">let _ </span>= Tables::open_tables_read_write(primary_path, MetricConf::default(), <span class="prelude-val">None</span>, <span class="prelude-val">Some</span>(config.build()));
<span class="prelude-val">Ok</span>(())
}
</code></pre></div>
<ol start="2">
<li>
<p>Auto-generated <code>open</code> routine
The function <code>open_tables_read_write</code> is generated which allows for specifying DB wide options and custom table configs as mentioned above</p>
</li>
<li>
<p>Auto-generated <code>read_only_mode</code> handle
This mode provides handle struct which opens the DB in read only mode and has certain features like dumping and counting the keys in the tables</p>
</li>
</ol>
<p>Use the function <code>Tables::get_read_only_handle</code> which returns a handle that only allows read only features</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code> <span class="kw">use </span>typed_store::rocks::DBOptions;
 <span class="kw">use </span>typed_store::rocks::DBMap;
 <span class="kw">use </span>typed_store_derive::DBMapUtils;
 <span class="kw">use </span>typed_store::traits::TypedStoreDebug;
 <span class="kw">use </span>core::fmt::Error;
 <span class="kw">use </span>typed_store::traits::TableSummary;
 <span class="doccomment">/// Define a struct with all members having type DBMap&lt;K, V&gt;

 </span><span class="kw">fn </span>custom_fn_name1() -&gt; DBOptions {DBOptions::default()}
 <span class="kw">fn </span>custom_fn_name2() -&gt; DBOptions {
     <span class="kw">let </span><span class="kw-2">mut </span>op = custom_fn_name1();
     op.options.set_write_buffer_size(<span class="number">123456</span>);
     op
 }
 <span class="attr">#[derive(DBMapUtils)]
 </span><span class="kw">struct </span>Tables {
     <span class="doccomment">/// Specify custom options function `custom_fn_name1`
     </span><span class="attr">#[default_options_override_fn = <span class="string">&quot;custom_fn_name1&quot;</span>]
     </span>table1: DBMap&lt;String, String&gt;,
     <span class="attr">#[default_options_override_fn = <span class="string">&quot;custom_fn_name2&quot;</span>]
     </span>table2: DBMap&lt;i32, String&gt;,
     <span class="comment">// Nothing specified so `typed_store::rocks::default_db_options` is used
     </span>table3: DBMap&lt;i32, String&gt;,
     <span class="attr">#[default_options_override_fn = <span class="string">&quot;custom_fn_name1&quot;</span>]
     </span>table4: DBMap&lt;i32, String&gt;,
 }
 <span class="attr">#[tokio::main]
 </span><span class="kw">async fn </span>main() -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {

 <span class="kw">use </span>typed_store::rocks::MetricConf;<span class="kw">let </span>primary_path = tempfile::tempdir().expect(<span class="string">&quot;Failed to open temporary directory&quot;</span>).into_path();
 <span class="kw">let _ </span>= Tables::open_tables_read_write(primary_path.clone(), typed_store::rocks::MetricConf::default(), <span class="prelude-val">None</span>, <span class="prelude-val">None</span>);

 <span class="comment">// Get the read only handle
 </span><span class="kw">let </span>read_only_handle = Tables::get_read_only_handle(primary_path, <span class="prelude-val">None</span>, <span class="prelude-val">None</span>, MetricConf::default());
 <span class="comment">// Use this handle for dumping
 </span><span class="kw">let </span>ret = read_only_handle.dump(<span class="string">&quot;table2&quot;</span>, <span class="number">100</span>, <span class="number">0</span>).unwrap();
 <span class="kw">let </span>key_count = read_only_handle.count_keys(<span class="string">&quot;table1&quot;</span>).unwrap();
 <span class="prelude-val">Ok</span>(())
 }</code></pre></div>
<ol start="4">
<li>
<p>Auto-generated memory stats method
<code>self.get_memory_usage</code> is derived to provide memory and cache usage</p>
</li>
<li>
<p>Other convenience features
<code>Tables::describe_tables</code> is used to get a list of the table names and key-value types as string in a BTreeMap</p>
</li>
</ol>
<p>// Bad usage example
// Structs fields most only be of type Store&lt;K, V&gt; or DMBap&lt;K, V&gt;
// This will fail to compile with error <code>All struct members must be of type Store&lt;K, V&gt; or DMBap&lt;K, V&gt;</code>
// #[derive(DBMapUtils)]
// struct BadTables {
//     table1: Store&lt;String, String&gt;,
//     bad_field: u32,
// #}</p>
</div></details></section></div></main></body></html>